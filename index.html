<html>

<head>
    <title>Notifications test</title>
</head>

<body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.1/jquery.min.js"></script>
<script type="text/javascript">
    // Function to gather data and trigger notification
    function processDataAndTrigger(forceRequestPermissions) {
        var text = $('#message').val();
        var seconds = $('#seconds').val();
        if (seconds) seconds = parseInt(seconds);
        showNotification(text, seconds, forceRequestPermissions);
    }

    function showNotification(text, closeTimeoutSeconds, forceRequestPermissions) {
//        // check if notifications are supported
//        if (!("Notification" in window)) {
//            alert('Not supported: Notification');
//            return;
//        }
//        if (!("webkitNotifications" in navigator)) {
//            alert('Not supported: webkitNotifications in navigator');
//            return;
//        }

        if (!("serviceWorker" in navigator)) {
            alert('Not supported: serviceWorker in navigator');
            return;
        }

        // notification logic
        var _notification = function (permission) {
            if (permission !== 'granted') {
                console.log('No notification permissions!');
                return;
            }
            var notification = new Notification('Notification title', {
                body: text
            });
            if (closeTimeoutSeconds && closeTimeoutSeconds > 0) {
                notification.onshow = function () {
                    setTimeout(function () {
                        this.close();
                    }.bind(this), closeTimeoutSeconds * 1000);
                }
            }
        };
        // check permissions and/or show notification
        if (forceRequestPermissions) {
            Notification.requestPermission(_notification);
        } else {
            _notification(Notification.permission);
        }
    }

    var _registration = null;

    function registerServiceWorker(path) {
        if (!('serviceWorker' in navigator)) {
            alert('Not supported: serviceWorker');
            return;
        }

        navigator.serviceWorker
                .register(path)
                .then(
                        function () {
                            console.log("Service Worker Registered");
                        },
                        function (err) {
                            console.error("Service worker err:", err);
                        });


//        navigator.serviceWorker.ready.then(function (registration) {
//            registration.showNotification('Notification with ServiceWorker');
//            registration.showNotification('Vibration Sample', {
//                body: 'Buzz! Buzz!',
//                vibrate: [200, 100, 200, 100, 200, 100, 200],
//                tag: 'vibration-sample'
//            });
//        });

        Notification.requestPermission(function(result) {
            if (result === 'granted') {
                navigator.serviceWorker.ready.then(function(registration) {
                    _registration = registration;
                    registration.showNotification('Notification with ServiceWorker');
                    registration.showNotification('Vibration Sample', {
                        body: 'Buzz! Buzz!',
                        vibrate: [200, 100, 200, 100, 200, 100, 200],
                        tag: 'vibration-sample'
                    });
                });
            }

        });

    }

    function swNotify () {
        if(_registration) {
            _registration.showNotification('Vibration Sample', {
                body: 'After Buzz',
                vibrate: [200, 100, 200, 100, 200, 100, 200],
                tag: 'vibration-sample'
            });
        }
    }

    // register sw
    registerServiceWorker(location.pathname + '/sw.js');

    $(document).ready(function () {
        var notificationSupported = "Notification" in window;
        var webkitNotificationsSupported = "webkitNotifications" in navigator;
        var content =
                "window.Notification is supported: " + notificationSupported + "<br>navigator.webkitNotifications is supported: " + webkitNotificationsSupported;
        document.getElementById('support').innerHTML = content;
    });
</script>
<div id="support"></div>
<input id="message" type="text" placeholder="Message..."/>
<input id="seconds" type="number" placeholder="Seconds to live..."/>
<button onclick="processDataAndTrigger(true)">request and show</button>
<button onclick="processDataAndTrigger()">show</button>
<button onclick="swNotify()">show</button>
</body>

</html>
